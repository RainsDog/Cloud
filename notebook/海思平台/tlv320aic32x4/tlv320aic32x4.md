# 海思主 codec从

## 海思的I2S配置

```shell
# 要能录能播，使用I2S2
# AIP2 IN / AOP0 OUT
# 海思提供MCLK BCLK WS
# 使用 AIP2 通路录音，AOP0 通路播放，4 线制外接 CODEC
# 可以配置为主或从模式，此时外接 CODEC 的接收与发送通道都选用 BCLK8，配置寄存器 I2S_CRG_CFG0_08 (m=0)和 I2S_CRG_CFG0_08 (m=0)。再启动 AIP2 和 AOP0 通道
# 配置寄存器 I2S_CRG_CFG0_08(m=0)为 0x003254E7，此时第 8 路时钟输出 mclk 频率为 12.288MHz
# 配置寄存器 I2S_CRG_CFG1_08(m=0)为 0x00000133，此时使能第 8 路时钟，同时把bclk 配置为 mclk 的 4 分频，fclk 配置为 bclk 的 64 分频，此时 fclk 频率为 48KHz


# 打开AIO时钟
himm 0x120400e4 0x02

# 设置MCLK = 12.288Mhz
himm 0x13140140 0x003254E7
0x0029F16B = 2748779
0x003254E7 = 3298535
# 设置BCLK WS ， 并设置海思为主模式
# 2*48k*16 = 1.536M
# BCLK=1.536M WLCK=48K
himm 0x13140144 0x00000115 # 8 & 32

# this is for test 
himm 0x13140144 0x00000133 # 4 + 64
himm 0x13140028 0x00000008 
himm 0x13141200 0xE4800014 



# 录音工作流程
himm 0x120400e4 0x02
himm 0x13140140 0x003254E7 #12.288
himm 0x13140144 0x00000115 #8 & 32
himm 0x13140028 0x00000008 #接收通道 0 内部 BCLK8
#接收通道 SD 线第 3bit 位连接接口SD3
#接收通道 SD 线第 2bit 位连接接口SD2
#接收通道 SD 线第 2bit 位连接接口SD1
#接收通道 SD 线第 0bit 位连接接口SD0
#接收通道的输入接口源选择0xa：I2S RX2 接口
himm 0x13141200 0xE4a00014
#分配 DDR 的起始地址
himm 0x13141280 0x6f000000
#分配 DDR_BUF 的大小
himm 0x13141284 0x0000f000
#初始化读写指针
himm 0x13141288 0x0	
himm 0x1314128c 0x0
#接收通道的数据传输长度
himm 0x13141294 0x00000f00
#使能trans_int 中断
himm 0x131412A0 0x00000001
#使能接收通道
himm 0x13141204 0x10000000

#disable
himm 0x13141204 0x000000
#中断状态寄存器
himm 0x131412A4
himm 0x131412A8 
#memmap
himd 0x6f000000 0x00000f00
himd 0x6f000000 0x0000f000
himc 0x6f000000 0xf000 0xffff



# once
himm 0x13141204 0x000000
himc 0x6f000000 0xf000 0xffff
himm 0x13141288 0x0	
himm 0x1314128c 0x0
himm 0x13141204 0x10000000
himd 0x6f000000 0x00000f00
```

## codec I2S设置

```less
# 选择0页，复位
i2c_write 1 0x30 0x00 0x00 1 1
i2c_write 1 0x30 0x01 0x01 1 1
usleep 10000

# test 
i2c_read 1 0x30 0x0B 0x0B 1 1 1

# 电源部分
VCC1.8V -> AVDD	# 模拟内核供电
VCC1.8V -> DVDD	# 数字内核供电
0.75V -> VREF	
3.3V -> LDOIN	# 提供给内部LDO以及器件的模拟输出放大器
3.3V -> IOVDD	# 数字IO单元

# 时钟部分
MCLK -> CODEC_CLKIN	# 不使用PLL去做那些复杂的设置
## 时钟设置目标
ADC_LCK = DAC_LCK = 12.288MHZ
ADC_MODULE_CLK = DAC_MODULE_CLK = 6.144MHZ
ADC_FS = DAC_FS = 48KHZ
NADC=NDAC=8
MADC=MDAC=2
AOSR=DOSR=128

//MLCK AS  CODEC_CLKIN
i2c_write 1 0x30 0x04 0x0 1 1	
i2c_write 1 0x30 0x05 0x0 1 1
i2c_write 1 0x30 0x06 0x0 1 1
i2c_write 1 0x30 0x07 0x0 1 1
i2c_write 1 0x30 0x08 0x0 1 1

//power up && div 8
i2c_write 1 0x30 0x0B 0x88 1 1
//power up && div 4
i2c_write 1 0x30 0x0C 0x82 1 1
//div 128
i2c_write 1 0x30 0x0D 0x00 1 1
i2c_write 1 0x30 0x0E 0x80 1 1	
//power up && div 8
i2c_write 1 0x30 0x12 0x88 1 1	
//power up && div 2
i2c_write 1 0x30 0x13 0x82 1 1	
//div 128
i2c_write 1 0x30 0x14 0x80 1 1	

//i2s 16bit slave
i2c_write 1 0x30 0x1B 0x00 1 1	
//dac config
i2c_write 1 0x30 0x3f 0xd4 1 1 	
//dac unmute
i2c_write 1 0x30 0x40 0x00 1 1	
//adc config
i2c_write 1 0x30 0x51 0xc0 1 1	
//adc unmute
i2c_write 1 0x30 0x52 0x00 1 1	

//page 1
i2c_write 1 0x30 0x00 0x01 1 1	
// Disabled weak connection of AVDD with DVDD
i2c_write 1 0x30 0x01 0x08 1 1 
//do what ? reset is 0x08
i2c_write 1 0x30 0x02 0x00 1 1 
//HP/LO/MA R/L power up
i2c_write 1 0x30 0x09 0xff 1 1  
//reset 0x00
i2c_write 1 0x30 0x0a 0x00 1 1 
//Left DAC positive terminal routed to HPL
i2c_write 1 0x30 0x0c 0x08 1 1	 
//Right DAC positive terminal routed to HPR
i2c_write 1 0x30 0x0d 0x08 1 1	
//reset 0x00
i2c_write 1 0x30 0x0e 0x00 1 1	
//reset 0x00
i2c_write 1 0x30 0x0f 0x00 1 1	
//HPL not muted
i2c_write 1 0x30 0x10 0x00 1 1	
//HPR not muted
i2c_write 1 0x30 0x11 0x00 1 1	
//LOL not muted
i2c_write 1 0x30 0x12 0x00 1 1	
//LOR not muted
i2c_write 1 0x30 0x13 0x00 1 1	
//IN2/IN3 input is weakly driveno common mode
i2c_write 1 0x30 0x3a 0xfc 1 1
//IN1L/IN2L/IN3L to Left MICPGA 10k
i2c_write 1 0x30 0x34 0x54 1 1 
//IN1R/IN2R/IN3R to Right MICPGA 10k
i2c_write 1 0x30 0x37 0x54 1 1	 
//IN2R/IN3R not to Left MICPGA
i2c_write 1 0x30 0x36 0x00 1 1	 
//IN1L/IN3L not to Right MICPGA
i2c_write 1 0x30 0x39 0x00 1 1	 

```

# sample

## 48kspsADC

```less
i2c_write 1 0x30 0x00 0x00 1 1
i2c_write 1 0x30 0x01 0x01 1 1
usleep 10000
i2c_write 1 0x30 0x12 0x81 1 1
i2c_write 1 0x30 0x13 0x82 1 1
i2c_write 1 0x30 0x14 0x80 1 1
i2c_write 1 0x30 0x3d 0x01 1 1

i2c_write 1 0x30 0x00 0x01 1 1
i2c_write 1 0x30 0x01 0x08 1 1 
i2c_write 1 0x30 0x02 0x00 1 1
i2c_write 1 0x30 0x0a 0x00 1 1
i2c_write 1 0x30 0x3d 0x00 1 1
i2c_write 1 0x30 0x47 0x32 1 1
i2c_write 1 0x30 0x7b 0x01 1 1
i2c_write 1 0x30 0x34 0x80 1 1
i2c_write 1 0x30 0x36 0x80 1 1
i2c_write 1 0x30 0x37 0x80 1 1
i2c_write 1 0x30 0x39 0x80 1 1
i2c_write 1 0x30 0x3b 0x0c 1 1
i2c_write 1 0x30 0x3c 0x0c 1 1

//HP/LO/MA R/L power up
i2c_write 1 0x30 0x09 0xff 1 1  
i2c_write 1 0x30 0x0c 0x08 1 1	
i2c_write 1 0x30 0x0d 0x18 1 1
//HPL not muted
i2c_write 1 0x30 0x10 0x00 1 1	
//HPR not muted
i2c_write 1 0x30 0x11 0x00 1 1	
//IN2/IN3 input is weakly driveno common mode
i2c_write 1 0x30 0x3a 0xfc 1 1
//IN1L/IN2L/IN3L to Left MICPGA 10k
i2c_write 1 0x30 0x34 0x54 1 1 
//IN1R/IN2R/IN3R to Right MICPGA 10k
i2c_write 1 0x30 0x37 0x54 1 1	 
//IN2R/IN3R not to Left MICPGA
i2c_write 1 0x30 0x36 0x00 1 1	 
//IN1L/IN3L not to Right MICPGA
i2c_write 1 0x30 0x39 0x00 1 1	

i2c_write 1 0x30 0x00 0x00 1 1
i2c_write 1 0x30 0x51 0xc0 1 1
i2c_write 1 0x30 0x52 0x00 1 1
```

# 信号控制块

|      | 信号控制块号 | 声道数 | 采样率 | xOSR |
| ---- | ------------ | ------ | ------ | ---- |
| ADC  | PRB_R1       | Stereo | 48kHz  | 128  |
| ADC  | PRB_R7       | Stereo | 48kHz  | 64   |
| ADC  | PRB_R4       | Mono   | 48kHz  | 128  |
| ADC  | PRB_R11      | Mono   | 48kHz  | 64   |
| ADC  | PRB_R1       | Stereo | 8kHz   | 128  |
| ADC  | PRB_R7       | Stereo | 8kHz   | 64   |
|      |              |        |        |      |
|      |              |        |        |      |
|      |              |        |        |      |

# 8168 的 3254 I2C指令

```cpp
i2c_write 0x01 0x30 0x01 0x01 1 1
i2c_write 0x01 0x30 0x00 0x00 1 1
i2c_write 0x01 0x30 0x04 0x03 1 1
i2c_write 0x01 0x30 0x05 0x91 1 1
i2c_write 0x01 0x30 0x06 0x08 1 1
i2c_write 0x01 0x30 0x07 0x00 1 1
i2c_write 0x01 0x30 0x08 0x00 1 1
i2c_write 0x01 0x30 0x0b 0x88 1 1
i2c_write 0x01 0x30 0x0c 0x82 1 1
i2c_write 0x01 0x30 0x0d 0x00 1 1
i2c_write 0x01 0x30 0x0e 0x80 1 1
i2c_write 0x01 0x30 0x12 0x88 1 1
i2c_write 0x01 0x30 0x13 0x84 1 1
i2c_write 0x01 0x30 0x14 0x40 1 1
i2c_write 0x01 0x30 0x1b 0x0c 1 1
i2c_write 0x01 0x30 0x1c 0x00 1 1
i2c_write 0x01 0x30 0x1d 0x01 1 1
i2c_write 0x01 0x30 0x1e 0x84 1 1
i2c_write 0x01 0x30 0x3f 0xd4 1 1
i2c_write 0x01 0x30 0x40 0x00 1 1
i2c_write 0x01 0x30 0x41 0x1a 1 1
i2c_write 0x01 0x30 0x42 0x1a 1 1
i2c_write 0x01 0x30 0x51 0xc0 1 1
i2c_write 0x01 0x30 0x52 0x77 1 1
i2c_write 0x01 0x30 0x53 0x20 1 1
i2c_write 0x01 0x30 0x54 0x20 1 1
i2c_write 0x01 0x30 0x56 0x61 1 1
i2c_write 0x01 0x30 0x57 0x78 1 1
i2c_write 0x01 0x30 0x58 0x33 1 1
i2c_write 0x01 0x30 0x59 0xe0 1 1
i2c_write 0x01 0x30 0x5a 0xe0 1 1
i2c_write 0x01 0x30 0x5b 0x19 1 1
i2c_write 0x01 0x30 0x5c 0x0c 1 1
i2c_write 0x01 0x30 0x5e 0x61 1 1
i2c_write 0x01 0x30 0x5f 0x78 1 1
i2c_write 0x01 0x30 0x60 0x33 1 1
i2c_write 0x01 0x30 0x61 0xe0 1 1
i2c_write 0x01 0x30 0x62 0xe0 1 1
i2c_write 0x01 0x30 0x63 0x19 1 1
i2c_write 0x01 0x30 0x64 0x0c 1 1



i2c_write 0x01 0x30 0x00 0x01 1 1
i2c_write 0x01 0x30 0x01 0x48 1 1
i2c_write 0x01 0x30 0x02 0x00 1 1
i2c_write 0x01 0x30 0x09 0x3f 1 1
i2c_write 0x01 0x30 0x0a 0x00 1 1
i2c_write 0x01 0x30 0x0c 0x08 1 1
i2c_write 0x01 0x30 0x0d 0x08 1 1
i2c_write 0x01 0x30 0x0e 0x08 1 1
i2c_write 0x01 0x30 0x0f 0x08 1 1
i2c_write 0x01 0x30 0x10 0x00 1 1
i2c_write 0x01 0x30 0x11 0x00 1 1
i2c_write 0x01 0x30 0x12 0x08 1 1
i2c_write 0x01 0x30 0x13 0x08 1 1
i2c_write 0x01 0x30 0x34 0x54 1 1
i2c_write 0x01 0x30 0x36 0x00 1 1
i2c_write 0x01 0x30 0x37 0x45 1 1
i2c_write 0x01 0x30 0x39 0x10 1 1
i2c_write 0x01 0x30 0x3a 0xfc 1 1
i2c_write 0x01 0x30 0x3b 0x0c 1 1
i2c_write 0x01 0x30 0x3c 0x0c 1 1
```

# 3254做主

```shell
himm 0x120400e4 0x02
himm 0x13140140 0x0064A9CE 
himm 0x13140144 0x00000d17
himm 0x13140028 0x00000008 
himm 0x13141200 0xE4a00014
himm 0x13141280 0x6f000000
himm 0x13141284 0x0000f000
himm 0x13141288 0x0	
himm 0x1314128c 0x0
himm 0x13141294 0x00000f00
himm 0x131412A0 0x00000001
himm 0x13141204 0x10000000

#disable
himm 0x13141204 0x000000
#中断状态寄存器
himm 0x131412A4
himm 0x131412A8 
#memmap
himd 0x6f000000 0x00000f00
himd 0x6f000000 0x0000f000
himc 0x6f000000 0xf000 0xffff



# once
himm 0x13141204 0x000000
himc 0x6f000000 0xf000 0xffff
himm 0x13141288 0x0	
himm 0x1314128c 0x0
himm 0x13141204 0x10000000
himd 0x6f000000 0x00000f00
```

# 3254 test

```shell
i2c_write 0x01 0x30 0x00 0x00 1 1
i2c_write 0x01 0x30 0x1d 0x11 1 1
i2c_write 0x01 0x30 0x1d 0x01 1 1
```

# 具有48ksps采样率和高性能的立体声ADC

```cpp
i2c_write 0x01 0x30 0x00 0x00 1 1
i2c_write 0x01 0x30 0x01 0x01 1 1
i2c_write 0x01 0x30 0x12 0x81 1 1
i2c_write 0x01 0x30 0x13 0x82 1 1
i2c_write 0x01 0x30 0x14 0x80 1 1
i2c_write 0x01 0x30 0x3d 0x01 1 1
i2c_write 0x01 0x30 0x00 0x01 1 1
i2c_write 0x01 0x30 0x01 0x08 1 1
i2c_write 0x01 0x30 0x02 0x00 1 1
i2c_write 0x01 0x30 0x0a 0x00 1 1
i2c_write 0x01 0x30 0x3d 0x00 1 1
i2c_write 0x01 0x30 0x47 0x32 1 1
i2c_write 0x01 0x30 0x7b 0x01 1 1
i2c_write 0x01 0x30 0x34 0x80 1 1
i2c_write 0x01 0x30 0x37 0x80 1 1
i2c_write 0x01 0x30 0x39 0x80 1 1
i2c_write 0x01 0x30 0x3b 0x0c 1 1
i2c_write 0x01 0x30 0x3c 0x0c 1 1
i2c_write 0x01 0x30 0x00 0x00 1 1
i2c_write 0x01 0x30 0x51 0xc0 1 1
i2c_write 0x01 0x30 0x52 0x00 1 1
```

# 具有48ksps采样率和低功耗的立体声ADC

```cpp
i2c_write 0x01 0x30 0x00 0x00 1 1
i2c_write 0x01 0x30 0x01 0x01 1 1
i2c_write 0x01 0x30 0x12 0x81 1 1
i2c_write 0x01 0x30 0x13 0x84 1 1
i2c_write 0x01 0x30 0x14 0x40 1 1
i2c_write 0x01 0x30 0x3d 0x07 1 1
i2c_write 0x01 0x30 0x00 0x01 1 1
i2c_write 0x01 0x30 0x01 0x08 1 1
i2c_write 0x01 0x30 0x02 0x00 1 1
i2c_write 0x01 0x30 0x0a 0x40 1 1
i2c_write 0x01 0x30 0x3d 0xff 1 1
i2c_write 0x01 0x30 0x47 0x32 1 1
i2c_write 0x01 0x30 0x7b 0x01 1 1
i2c_write 0x01 0x30 0x34 0x80 1 1
i2c_write 0x01 0x30 0x36 0x80 1 1
i2c_write 0x01 0x30 0x37 0x80 1 1
i2c_write 0x01 0x30 0x39 0x80 1 1
i2c_write 0x01 0x30 0x3b 0x0c 1 1
i2c_write 0x01 0x30 0x3c 0x0c 1 1
i2c_write 0x01 0x30 0x00 0x00 1 1
i2c_write 0x01 0x30 0x51 0xc0 1 1
i2c_write 0x01 0x30 0x52 0x00 1 1
```

# 具有48ksps采样率和高性能的立体声DAC播放

```cpp

i2c_write 0x01 0x30 0x00 0x00 1 1
i2c_write 0x01 0x30 0x01 0x01 1 1
i2c_write 0x01 0x30 0x0b 0x81 1 1
i2c_write 0x01 0x30 0x0c 0x82 1 1
i2c_write 0x01 0x30 0x0d 0x00 1 1
i2c_write 0x01 0x30 0x0e 0x80 1 1
i2c_write 0x01 0x30 0x1b 0x10 1 1
i2c_write 0x01 0x30 0x3c 0x08 1 1
i2c_write 0x01 0x30 0x00 0x01 1 1
i2c_write 0x01 0x30 0x01 0x08 1 1
i2c_write 0x01 0x30 0x02 0x00 1 1
i2c_write 0x01 0x30 0x7b 0x01 1 1
i2c_write 0x01 0x30 0x14 0x25 1 1
i2c_write 0x01 0x30 0x0a 0x00 1 1
i2c_write 0x01 0x30 0x0c 0x08 1 1
i2c_write 0x01 0x30 0x0d 0x08 1 1
i2c_write 0x01 0x30 0x03 0x00 1 1
i2c_write 0x01 0x30 0x04 0x00 1 1
i2c_write 0x01 0x30 0x10 0x00 1 1
i2c_write 0x01 0x30 0x11 0x00 1 1
i2c_write 0x01 0x30 0x09 0x30 1 1
i2c_write 0x01 0x30 0x00 0x00 1 1
i2c_write 0x01 0x30 0x3f 0xd6 1 1
i2c_write 0x01 0x30 0x40 0x00 1 1
```

# sampled的修改

```cpp
#define TLV320_FILE "/dev/tlv320aic32x4"

Makefile.param
#external acodec
#ACODEC_TYPE ?= ACODEC_TYPE_TP2823
#ACODEC_TYPE ?= ACODEC_TYPE_NVP6134
ACODEC_TYPE ?= ACODEC_TYPE_TLV320AIC
    
ifeq ($(ACODEC_TYPE), ACODEC_TYPE_TLV320AIC)
        CFLAGS += -DHI_ACODEC_TYPE_TLV320AIC31
endif
    
Audio_Ctrl结构体的chip_num改为chn_num //驱动改
    
    
    SAMPLE_Tlv320_CfgAudio(pstAioAttr);
    
```

